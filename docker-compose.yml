services:
  # ========================================
  # 1. Banco de Dados (Postgres)
  # ========================================
  postgres:
    image: postgres:15
    container_name: evolution_postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=evolution
      - POSTGRES_PASSWORD=evolution
      - POSTGRES_DB=evolution
    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data
    networks:
      - voice_sdr_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution -d evolution"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 60s

  # ========================================
  # 2. Redis
  # ========================================
  redis:
    image: redis:alpine
    container_name: evolution_redis
    command: redis-server --appendonly yes --requirepass 123456
    volumes:
      - ./evolution_data/redis:/data
    networks:
      - voice_sdr_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "123456", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # 3. Evolution API V2
  # ========================================
  evolution-api:
    image: evoapicloud/evolution-api:v2.3.0
    container_name: evolution_whatsapp
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    dns:
      - 8.8.8.8
      - 8.8.4.4
    shm_size: '2gb' 
    ports:
      - "8080:8080"
    environment:
      - SERVER_URL=http://localhost:8080
      - DOCKER_ENV=true
      - AUTHENTICATION_API_KEY=123456
      - LOG_LEVEL=ERROR
      - LOG_BAILEYS=error
      
      # Banco e Cache
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution@postgres:5432/evolution?schema=public&connection_limit=5
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://:123456@redis:6379/0
      
      # WebSocket 
      - WEBSOCKET_MAX_PAYLOAD=104857600
      - WEBSOCKET_PING_INTERVAL=20000
      - WEBSOCKET_PONG_TIMEOUT=60000
      
      # Webhook
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_URL=http://voice_sdr_bot:8000/webhook/evolution
      - WEBHOOK_EVENTS=MESSAGES_UPSERT,CONNECTION_UPDATE,QRCODE_UPDATED
      
      # Chrome
      - CONFIG_SESSION_PHONE_CLIENT=VoiceSDR
      - CONFIG_SESSION_PHONE_NAME=Chrome
      - CHROME_ARGS=--no-sandbox --disable-dev-shm-usage --disable-gpu --disable-setuid-sandbox
      - DEL_INSTANCE=false
      - QRCODE_LIMIT=30
      
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    networks:
      - voice_sdr_network

  # ========================================
  # 4. Bot (Sua Aplicação)
  # ========================================
  sdr-bot:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: voice_sdr_bot
    restart: unless-stopped
    depends_on:
      - evolution-api 
    ports:
      - "${PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      - EVOLUTION_API_URL=http://evolution-api:8080
      - EVOLUTION_API_KEY=123456
      # Variáveis do Azure TTS
      - AZURE_TTS_SUBSCRIPTION_KEY=${AZURE_TTS_SUBSCRIPTION_KEY}
      - AZURE_TTS_REGION=${AZURE_TTS_REGION}
      - AZURE_TTS_VOICE_NAME=${AZURE_TTS_VOICE_NAME}
      # Outras configurações
      - RESPONSE_TYPE=${RESPONSE_TYPE}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL}
    volumes:
      # --- PERSISTÊNCIA DE MEMÓRIA ---
      # Mapeia o arquivo do host para o container.
      # Importante: Crie este arquivo vazio no Windows antes de rodar.
      - ./chat_history.json:/app/chat_history.json
    networks:
      - voice_sdr_network

networks:
  voice_sdr_network:
    driver: bridge

# ========================================
# Definição dos Volumes Internos
# ========================================
volumes:
  evolution_instances:
  evolution_store:
  evolution_postgres_data: